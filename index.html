<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç”Ÿæ´»å‹•æ—¥ç¨‹æŸ¥è©¢ç³»çµ±</title>
    <style>
        body {
            font-family: "Microsoft JhengHei", -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: #f8f9fa;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .control-panel {
            background-color: #e9ecef;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .input-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: white;
            padding: 10px 15px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        .input-group label {
            font-weight: bold;
            margin-right: 15px;
            min-width: 220px;
        }
        .input-group input {
            flex-grow: 1;
            padding: 8px;
            font-size: 16px;
            border: 1px solid #ced4da;
            border-radius: 4px;
        }

        /* æœå°‹å€å¡Šæ¨£å¼ */
        .search-container {
            margin-top: 10px;
            padding: 15px;
            background-color: #d1ecf1;
            border-radius: 5px;
            border: 1px solid #bee5eb;
        }
        .search-header {
            font-weight: bold;
            color: #0c5460;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .search-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap; 
        }
        .search-controls select, 
        .search-controls input {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #17a2b8;
            font-size: 1rem;
        }
        .search-controls select {
            background-color: white;
            cursor: pointer;
            min-width: 150px;
        }
        .search-controls input {
            flex-grow: 1;
        }
        
        .input-hidden {
            display: none !important;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            font-size: 0.85em;
            border-radius: 4px;
            margin-left: 10px;
        }
        .status-ok { background-color: #d4edda; color: #155724; }
        .status-wait { background-color: #fff3cd; color: #856404; }
        
        .activity-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .activity-header {
            background-color: #007bff;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        .activity-title {
            font-size: 1.25rem;
            font-weight: bold;
            margin: 0;
        }
        .activity-info {
            font-size: 0.9rem;
            background-color: rgba(255,255,255,0.2);
            padding: 5px 10px;
            border-radius: 4px;
            margin-left: 5px;
        }
        .student-table {
            width: 100%;
            border-collapse: collapse;
        }
        .student-table th, .student-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        .student-table th {
            background-color: #f1f3f5;
            color: #495057;
            font-weight: 600;
        }
        .highlight {
            background-color: #fff3cd;
            font-weight: bold;
        }
        .lunch-tag {
            display: inline-block;
            padding: 3px 8px;
            font-size: 0.8em;
            border-radius: 10px;
            background-color: #28a745;
            color: white;
        }
        .no-lunch {
            color: #adb5bd;
        }
        .error-msg {
            color: #dc3545;
            text-align: center;
            margin-top: 10px;
            font-weight: bold;
        }
        .hint {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 5px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ“… å­¸ç”Ÿæ´»å‹•æ—¥ç¨‹æŸ¥è©¢</h1>
    
    <div class="control-panel">
        <div class="input-group">
            <label>1. æ´»å‹•æ—¥ç¨‹ (other_data.csv):</label>
            <span id="scheduleStatus" class="status-badge status-wait">è®€å–ä¸­...</span>
        </div>

        <div class="input-group">
            <label for="studentFile">2. ä¸Šå‚³å­¸ç”Ÿåå–® (data.csv):</label>
            <input type="file" id="studentFile" accept=".csv">
            <span id="studentStatus" class="status-badge status-wait">ç­‰å¾…ä¸Šå‚³</span>
        </div>
        <div class="hint">è«‹ä¸Šå‚³åŒ…å« Name, Class, ClassNo, Activity ç­‰æ¬„ä½çš„ CSV æª”æ¡ˆã€‚</div>

        <div class="input-group" style="margin-top: 10px; border-color: #007bff;">
            <label for="datePicker">3. é¸æ“‡æŸ¥è©¢æ—¥æœŸ:</label>
            <input type="date" id="datePicker" disabled>
        </div>

        <div class="search-container">
            <div class="search-header">
                ğŸ” æœå°‹èˆ‡ç¯©é¸
            </div>
            <div class="search-controls">
                <select id="searchMode" disabled>
                    <option value="activity">æ¨¡å¼ 1: ä¾æ´»å‹•ç¯©é¸ (ä¸‹æ‹‰é¸å–®)</option>
                    <option value="name">æ¨¡å¼ 2: åƒ…æœå°‹å§“å</option>
                    <option value="class">æ¨¡å¼ 3: åƒ…æœå°‹ç­åˆ¥ (e.g. 4A)</option>
                    <option value="batch">æ¨¡å¼ 4: æ‰¹é‡æœå°‹ (e.g. 1A5, 5D18)</option>
                </select>

                <select id="activityList" class="input-hidden" style="flex-grow:1;">
                    <option value="">-- è«‹å…ˆé¸æ“‡æ—¥æœŸ --</option>
                </select>

                <input type="text" id="inputMain" placeholder="è¼¸å…¥å§“å..." class="input-hidden">
                
                </div>
        </div>
    </div>

    <div id="error" class="error-msg"></div>
    <div id="results"></div>
</div>

<script>
    let studentsData = [];
    let scheduleData = [];
    let isScheduleLoaded = false;
    let isStudentLoaded = false;

    // CSV è§£æå‡½æ•¸
    function parseCSV(text) {
        const lines = text.split('\n').filter(line => line.trim() !== '');
        if (lines.length < 2) return [];
        const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, '')); 
        
        return lines.slice(1).map(line => {
            const values = [];
            let match;
            const regex = /(?:^|,)(\"(?:[^\"]+|\"\")*\"|[^,]*)/g;
            let currentLine = line;
            while (match = regex.exec(currentLine)) {
                let val = match[1].replace(/^"|"$/g, '').trim();
                values.push(val);
            }
            const simpleValues = line.split(',');
            const finalValues = values.length === headers.length ? values : simpleValues;

            const entry = {};
            headers.forEach((h, i) => {
                entry[h] = finalValues[i] ? finalValues[i].trim() : '';
            });
            return entry;
        });
    }

    // æ—¥æœŸè½‰æ› (dd/mm/yyyy -> yyyy-mm-dd)
    function convertDDMMYYYYToISO(dateStr) {
        if (!dateStr) return null;
        const parts = dateStr.trim().split('/');
        if (parts.length === 3) {
            const day = parts[0].padStart(2, '0');
            const month = parts[1].padStart(2, '0');
            const year = parts[2];
            return `${year}-${month}-${day}`;
        }
        return null;
    }

    // åˆ¤æ–·å¤šæ—¥æœŸ
    function isActivityOnDate(activityDateStr, selectedISODate) {
        if (!activityDateStr) return false;
        const dates = activityDateStr.split(',');
        for (let d of dates) {
            const iso = convertDDMMYYYYToISO(d.trim());
            if (iso === selectedISODate) {
                return true;
            }
        }
        return false;
    }

    // ä»‹é¢å•Ÿç”¨æª¢æŸ¥
    function checkReady() {
        const datePicker = document.getElementById('datePicker');
        const searchMode = document.getElementById('searchMode');
        
        if (isScheduleLoaded && isStudentLoaded) {
            datePicker.disabled = false;
            datePicker.placeholder = "è«‹é¸æ“‡æ—¥æœŸ";
            searchMode.disabled = false;
            updateUIByMode(); 
        } else {
            datePicker.disabled = true;
            searchMode.disabled = true;
        }
    }

    function updateUIByMode() {
        const mode = document.getElementById('searchMode').value;
        const activityList = document.getElementById('activityList');
        const inputMain = document.getElementById('inputMain');
        
        // å…ˆé‡ç½®
        activityList.classList.add('input-hidden');
        inputMain.classList.add('input-hidden');
        inputMain.value = '';

        if (mode === 'activity') {
            activityList.classList.remove('input-hidden');
        } 
        else if (mode === 'name') {
            inputMain.classList.remove('input-hidden');
            inputMain.placeholder = 'è¼¸å…¥å§“å...';
        } 
        else if (mode === 'class') {
            inputMain.classList.remove('input-hidden');
            inputMain.placeholder = 'è¼¸å…¥ç­åˆ¥ (ä¾‹å¦‚ 4A)...';
        } 
        else if (mode === 'batch') {
            inputMain.classList.remove('input-hidden');
            inputMain.placeholder = 'è¼¸å…¥å­¸ç”Ÿä»£ç¢¼ (ä¾‹å¦‚ 1A5, 5D18, 6A2)...';
        }
    }

    // æ›´æ–°æ´»å‹•ä¸‹æ‹‰é¸å–®
    function updateActivityDropdown(selectedISODate) {
        const activitySelect = document.getElementById('activityList');
        activitySelect.innerHTML = '<option value="">-- é¡¯ç¤ºæ‰€æœ‰æ´»å‹• --</option>';

        if (!selectedISODate) return;

        const todaysActivities = scheduleData.filter(item => {
            return isActivityOnDate(item.Date, selectedISODate);
        });

        const uniqueActivities = [...new Set(todaysActivities.map(item => item.Activity))];

        uniqueActivities.forEach(actName => {
            const option = document.createElement('option');
            option.value = actName;
            option.textContent = actName;
            activitySelect.appendChild(option);
        });
    }

    // --- è³‡æ–™åŠ è¼‰ ---
    async function loadScheduleFromServer() {
        const statusSpan = document.getElementById('scheduleStatus');
        const errorDiv = document.getElementById('error');
        try {
            const response = await fetch('other_data.csv');
            if (!response.ok) throw new Error('ç„¡æ³•è®€å–æª”æ¡ˆ (404)');
            const text = await response.text();
            scheduleData = parseCSV(text);
            isScheduleLoaded = true;
            statusSpan.textContent = `å·²è¼‰å…¥ (å…± ${scheduleData.length} ç­†æ´»å‹•)`;
            statusSpan.className = 'status-badge status-ok';
            checkReady();
        } catch (err) {
            console.error(err);
            statusSpan.textContent = 'è¼‰å…¥å¤±æ•—';
            statusSpan.style.backgroundColor = '#f8d7da';
            errorDiv.textContent = 'éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° other_data.csvã€‚';
        }
    }

    document.getElementById('studentFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const statusSpan = document.getElementById('studentStatus');
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                studentsData = parseCSV(e.target.result);
                isStudentLoaded = true;
                statusSpan.textContent = `å·²è¼‰å…¥ (å…± ${studentsData.length} ä½å­¸ç”Ÿ)`;
                statusSpan.className = 'status-badge status-ok';
                checkReady();
                refreshDisplay();
            } catch (err) { alert("CSV è§£æå¤±æ•—"); }
        };
        reader.readAsText(file);
    });

    // --- äº‹ä»¶ç›£è½ ---
    document.getElementById('searchMode').addEventListener('change', function() {
        updateUIByMode();
        refreshDisplay();
    });

    document.getElementById('datePicker').addEventListener('change', function(e) {
        const dateVal = e.target.value;
        updateActivityDropdown(dateVal);
        refreshDisplay();
    });

    document.getElementById('activityList').addEventListener('change', refreshDisplay);
    document.getElementById('inputMain').addEventListener('input', refreshDisplay);

    function refreshDisplay() {
        const dateVal = document.getElementById('datePicker').value;
        if (dateVal) displayResults(dateVal);
    }

    // --- æ ¸å¿ƒé¡¯ç¤ºé‚è¼¯ ---
    function displayResults(selectedISODate) {
        const container = document.getElementById('results');
        container.innerHTML = '';
        
        if (!selectedISODate || !isScheduleLoaded || !isStudentLoaded) return;

        const mode = document.getElementById('searchMode').value;
        const activityFilterVal = document.getElementById('activityList').value; 
        const valMain = document.getElementById('inputMain').value.trim(); // é€™è£¡å…ˆä¸è½‰å°å¯«ï¼Œä»¥ä¾¿è™•ç† Class

        // 1. ç¯©é¸æ´»å‹•
        let todaysActivities = scheduleData.filter(item => {
            return isActivityOnDate(item.Date, selectedISODate);
        });

        if (todaysActivities.length === 0) {
            container.innerHTML = `<p style="text-align:center; color:#666; margin-top:20px;">
                ğŸ“… ${selectedISODate} æ²’æœ‰æ‰¾åˆ°ä»»ä½•æ´»å‹•è³‡æ–™ã€‚
            </p>`;
            return;
        }

        // æ¨¡å¼1: ä¾æ´»å‹•ç¯©é¸
        if (mode === 'activity' && activityFilterVal !== '') {
            todaysActivities = todaysActivities.filter(item => item.Activity === activityFilterVal);
        }

        // é è™•ç†ã€Œæ‰¹é‡æœå°‹ã€çš„æ¨™ç±¤ (å¦‚æœæ˜¯åœ¨æ¨¡å¼4)
        let batchTargets = [];
        if (mode === 'batch' && valMain.length > 0) {
            // åˆ†å‰²ä½¿ç”¨è€…è¼¸å…¥: "1A5, 5D18" -> ["1A5", "5D18"]
            const tokens = valMain.toUpperCase().split(/[\s,]+/).filter(t => t.length > 0);
            
            // è§£ææ¯å€‹ token: "1A5" -> { cls: "1A", no: 5 }
            // å‡è¨­æ ¼å¼ç‚º: æ•¸å­—+è‹±æ–‡+æ•¸å­— (ä¾‹å¦‚ 1A5, 6D12)
            // Regex: é–‹é ­æ˜¯æ•¸å­—å’Œå­—æ¯(Class)ï¼Œçµå°¾æ˜¯æ•¸å­—(ClassNo)
            const regex = /^(\d+[A-Z])(\d+)$/;
            
            tokens.forEach(token => {
                const match = token.match(regex);
                if (match) {
                    batchTargets.push({
                        cls: match[1],         // e.g. "1A"
                        no: parseInt(match[2]) // e.g. 5
                    });
                }
            });
        }

        let hasResult = false;

        // 2. éæ­·æ´»å‹•
        todaysActivities.forEach(activity => {
            const activityName = activity.Activity;
            let participants = studentsData.filter(s => s.Activity === activityName);

            // 3. éæ¿¾åå–®
            if (mode !== 'activity') {
                participants = participants.filter(s => {
                    const sName = (s.Name || '').toLowerCase();
                    const sClass = (s.Class || '').toUpperCase().trim();
                    const sNo = parseInt(s.ClassNo || '0');
                    const inputLower = valMain.toLowerCase();

                    if (mode === 'name') {
                        return sName.includes(inputLower);
                    } 
                    else if (mode === 'class') {
                        // Class ç²¾ç¢ºåŒ¹é… (ä¸åˆ†å¤§å°å¯«)
                        return valMain === '' || sClass === inputLower.toUpperCase();
                    } 
                    else if (mode === 'batch') {
                        // æ‰¹é‡åŒ¹é…
                        if (batchTargets.length === 0) return true; // æœªè¼¸å…¥æ™‚é¡¯ç¤ºæ‰€æœ‰? æˆ–è€…é¡¯ç¤ºç©º? é€™è£¡è¨­å®šç‚º:æœªè¼¸å…¥é¡¯ç¤ºç©º
                        if (valMain.trim() === '') return true; // å¦‚æœè¼¸å…¥æ¡†å®Œå…¨æ˜¯ç©ºçš„ï¼Œå°±é¡¯ç¤ºå…¨éƒ¨ (å¯é¸) -> é€™è£¡ä¿æŒã€Œæœ‰è¼¸å…¥æ‰éæ¿¾ã€

                        // æª¢æŸ¥é€™ä½å­¸ç”Ÿæ˜¯å¦åœ¨ batchTargets åˆ—è¡¨ä¸­
                        return batchTargets.some(target => {
                            return target.cls === sClass && target.no === sNo;
                        });
                    }
                    return true;
                });

                // å¦‚æœæœ‰è¼¸å…¥æœå°‹å…§å®¹ï¼Œä¸”æ²’äººç¬¦åˆï¼Œå°±è·³éæ­¤æ´»å‹•
                const hasInput = valMain.length > 0;
                if (hasInput && participants.length === 0) {
                    return;
                }
            }

            hasResult = true;

            const card = document.createElement('div');
            card.className = 'activity-card';

            const header = document.createElement('div');
            header.className = 'activity-header';
            header.innerHTML = `
                <div class="activity-title">${activityName}</div>
                <div style="text-align:right;">
                    <span class="activity-info">ğŸ•’ ${activity.Time || '--'}</span>
                    <span class="activity-info">ğŸ“ ${activity.Location || '--'}</span>
                    <span class="activity-info">ğŸ‘¤ ${activity.TIC || '--'}</span>
                </div>
            `;
            card.appendChild(header);

            if (participants.length > 0) {
                const table = document.createElement('table');
                table.className = 'student-table';
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th width="15%">ç­åˆ¥</th>
                            <th width="15%">å­¸è™Ÿ</th>
                            <th width="30%">å§“å</th>
                            <th width="40%">å‚™è¨» / é€±äº”åˆè†³</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${participants.map(s => {
                            const stayLunch = s['Stay Lunch'] && s['Stay Lunch'].trim().length > 0;
                            const lunchBadge = stayLunch 
                                ? `<span class="lunch-tag">ç•™æ ¡åˆè†³: ${s['Stay Lunch']}</span>` 
                                : '<span class="no-lunch">-</span>';
                            
                            // é«˜äº®é‚è¼¯
                            let rowClass = (mode !== 'activity' && valMain.length > 0) ? 'highlight' : '';

                            return `
                                <tr class="${rowClass}">
                                    <td>${s.Class}</td>
                                    <td>${s.ClassNo || '-'}</td>
                                    <td>${s.Name}</td>
                                    <td>${lunchBadge}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                `;
                card.appendChild(table);
            } else {
                const noData = document.createElement('div');
                noData.style.padding = '15px';
                noData.style.color = '#777';
                noData.textContent = `ç„¡å­¸ç”Ÿè³‡æ–™`;
                card.appendChild(noData);
            }

            container.appendChild(card);
        });

        if (!hasResult) {
            container.innerHTML = `<p style="text-align:center; color:#dc3545; margin-top:20px;">
                ğŸ” æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„æ´»å‹•æˆ–å­¸ç”Ÿã€‚
            </p>`;
        }
    }

    loadScheduleFromServer();

</script>

</body>
</html>
